{% extends 'base.html' %}

{% block title %}Category - Digital Nursery{% endblock %}

{% block content %}
<style>
.category-container {
    background: #f8f9fa;
    min-height: 100vh;
    padding-bottom: 140px; /* Ù…Ø³Ø§Ø­Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø³Ù„Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© */
}

/* Header */
.category-header {
    background: white;
    padding: 15px;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    align-items: center;
    gap: 15px;
}

.back-button {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
}

.back-button:hover {
    background: #f0f0f0;
}

.category-title {
    font-size: 20px;
    font-weight: 700;
    color: #034b06;
    flex: 1;
}

/* Products Grid */
.products-section {
    padding: 15px;
}

.products-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

.product-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.product-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.product-image {
    width: 100%;
    height: 150px;
    object-fit: cover;
}

.product-info {
    padding: 12px;
}

.product-name {
    font-size: 14px;
    font-weight: 700;
    color: #034b06;
    margin-bottom: 5px;
    line-height: 1.2;
}

.product-details {
    font-size: 12px;
    color: #666;
    margin-bottom: 8px;
    line-height: 1.3;
}

.product-company {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 8px;
}

.company-logo {
    width: 16px;
    height: 16px;
    border-radius: 4px;
}

.company-name {
    font-size: 11px;
    color: #888;
    font-weight: 500;
}

.product-price-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.product-price {
    font-size: 16px;
    font-weight: 700;
    color: #034b06;
    background: #e8f5e9;
    padding: 4px 8px;
    border-radius: 6px;
}

.add-button {
    background: #034b06;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    flex-shrink: 0;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(3, 75, 6, 0.3);
    font-size: 12px;
}

.add-button:hover {
    background: #06700b;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(3, 75, 6, 0.4);
}

.add-button.added {
    background: #4caf50;
    transform: scale(0.95);
}

/* Loading State */
.loading {
    text-align: center;
    padding: 40px;
    color: #666;
}

/* No Products State */
.no-products {
    text-align: center;
    padding: 40px;
    color: #666;
}

.no-products-icon {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.5;
}

/* Floating Cart - GREEN - IMPROVED POSITIONING */
.floating-cart {
    position: fixed;
    bottom: 70px; /* ÙÙˆÙ‚ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© */
    left: 0;
    right: 0;
    background: white;
    padding: 15px;
    box-shadow: 0 -4px 20px rgba(3, 75, 6, 0.15);
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 1001; /* Ù‚ÙŠÙ…Ø© Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ */
    border-top: 3px solid #034b06;
    margin: 0 10px;
    border-radius: 12px;
    max-width: calc(100% - 20px);
    margin-left: auto;
    margin-right: auto;
}

.cart-label {
    font-size: 16px;
    font-weight: 600;
    color: #034b06;
}

.cart-total {
    font-size: 18px;
    font-weight: 700;
    color: #034b06;
}

.view-cart-btn {
    background: #034b06;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(3, 75, 6, 0.3);
}

.view-cart-btn:hover:not(:disabled) {
    background: #06700b;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(3, 75, 6, 0.4);
}

.view-cart-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* Notification */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #4caf50;
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    display: none;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* Responsive */
@media (max-width: 480px) {
    .products-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<!-- Notification Element -->
<div id="notification" class="notification"></div>

<div class="category-container">
    <!-- Header -->
    <div class="category-header">
        <button class="back-button" onclick="goBack()">â†</button>
        <div class="category-title" id="categoryTitle">Loading...</div>
    </div>

    <!-- Products Grid -->
    <div class="products-section">
        <div class="products-grid" id="productsGrid">
            <div class="loading">Loading products...</div>
        </div>
    </div>

    <!-- Floating Cart - IMPROVED POSITIONING -->
    <div class="floating-cart">
        <div>
            <div class="cart-label">ğŸ›’ Ø§Ù„Ø³Ù„Ø©</div>
            <div class="cart-total">0.000 Ø±.Ø¹</div>
        </div>
        <a href="{{ url_for('main.user_cart') }}" class="footer-btn{% if request.endpoint == 'main.home' %} active{% endif %}" id="footerHomeBtn" title="Home">
            <button class="view-cart-btn" disabled>Ø§Ø¸Ù‡Ø§Ø± Ø§Ù„Ø³Ù„Ø©</button>
        </a>
    </div>
</div>

<script>
let cart = [];
let cartTotal = 0;

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ category ID Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
function getCategoryId() {
    const path = window.location.pathname;
    const match = path.match(/\/category\/(\d+)/);
    return match ? match[1] : null;
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.style.background = type === 'success' ? '#4caf50' : '#f44336';
    notification.style.display = 'block';
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

// Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø© Ø¹Ø¨Ø± API
async function addToCartAPI(productName, price) {
    try {
        const response = await fetch('/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                product_name: productName,
                price: price,
                quantity: 1,
                currency: 'OMR'
            })
        });

        if (response.ok) {
            const result = await response.json();
            return result;
        } else {
            throw new Error('Failed to add item to cart');
        }
    } catch (error) {
        console.error('Error adding to cart:', error);
        throw error;
    }
}

// Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
async function loadCategoryProducts() {
    const categoryId = getCategoryId();
    if (!categoryId) {
        showError('Category not found');
        return;
    }

    try {
        // Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØµÙ†ÙŠÙ
        const categoryResponse = await fetch(`/api/category/${categoryId}`);
        const category = await categoryResponse.json();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        const titleElement = document.getElementById('categoryTitle');
        titleElement.textContent = document.body.dir === 'rtl' ? 
            (category.name_ar || 'Ø§Ù„ØªØµÙ†ÙŠÙ') : 
            (category.name_en || 'Category');

        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        const productsResponse = await fetch(`/api/products/${categoryId}`);
        const products = await productsResponse.json();
        
        displayProducts(products);
        
    } catch (error) {
        console.error('Error loading category products:', error);
        showError('Failed to load products');
    }
}

// Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
function displayProducts(products) {
    const grid = document.getElementById('productsGrid');
    
    if (!products || products.length === 0) {
        grid.innerHTML = `
            <div class="no-products">
                <div class="no-products-icon">ğŸŒ±</div>
                <div>No products found in this category</div>
            </div>
        `;
        return;
    }

    grid.innerHTML = '';
    
    products.forEach(product => {
        const productCard = document.createElement('div');
        productCard.className = 'product-card';
        
        productCard.innerHTML = `
            <img src="${product.image}" alt="${product.name}" class="product-image" 
                 onerror="this.src='https://images.unsplash.com/photo-1485955900006-10f4d324d411?auto=format&fit=crop&w=300&q=80'">
            <div class="product-info">
                <div class="product-name">${product.name}</div>
                <div class="product-details">${product.details}</div>
                <div class="product-company">
                    <img src="${product.company_logo}" alt="${product.company_name}" class="company-logo"
                         onerror="this.style.display='none'">
                    <span class="company-name">${product.company_name}</span>
                </div>
                <div class="product-price-section">
                    <div class="product-price">${product.price} OMR</div>
                    <button class="add-button" onclick="addToCart('${product.name.replace(/'/g, "\\'")}', ${product.price}, this)">
                        Ø§Ø¶Ø§ÙØ©
                    </button>
                </div>
            </div>
        `;
        
        grid.appendChild(productCard);
    });
}

async function addToCart(productName, price, button) {
    const item = {
        name: productName,
        price: price,
        quantity: 1
    };
    
    // Show loading state
    button.textContent = 'ØªØªÙ… Ø§Ù„Ø§Ø¶Ø§ÙØ©';
    button.disabled = true;
    
    try {
        // Send request to backend
        await addToCartAPI(productName, parseFloat(price));
        
        // Update local cart
        cart.push(item);
        updateCartTotal();
        
        // Show success feedback
        button.textContent = 'ØªÙ…Øª Ø§Ù„Ø§Ø¶Ø§ÙØ©';
        button.classList.add('added', 'success');
        showNotification('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');
        
        setTimeout(() => {
            button.textContent = 'Ø§Ø¶Ø§ÙØ©';
            button.classList.remove('added', 'success');
            button.disabled = false;
        }, 1000);
        
    } catch (error) {
        // Show error feedback
        button.textContent = 'Ø®Ø·Ø§!';
        button.style.background = '#f44336';
        showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©', 'error');
        
        setTimeout(() => {
            button.textContent = 'Ø§Ø¶Ø§ÙØ©';
            button.style.background = '';
            button.disabled = false;
        }, 1000);
    }
}

function updateCartTotal() {
    cartTotal = cart.reduce((total, item) => total + (parseFloat(item.price) * item.quantity), 0);
    document.querySelector('.cart-total').textContent = `${cartTotal.toFixed(3)} Ø±.Ø¹`;
    
    const viewCartBtn = document.querySelector('.view-cart-btn');
    if (cartTotal > 0) {
        viewCartBtn.disabled = false;
    } else {
        viewCartBtn.disabled = true;
    }
}

// Ø¹Ø±Ø¶ Ø®Ø·Ø£
function showError(message) {
    const grid = document.getElementById('productsGrid');
    grid.innerHTML = `
        <div class="no-products">
            <div class="no-products-icon">âŒ</div>
            <div>${message}</div>
        </div>
    `;
}

// Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø®Ù„Ù
function goBack() {
    window.history.back();
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„ØºØ©
async function loadLanguage() {
    try {
        const response = await fetch('/get_language');
        const data = await response.json();
        applyLanguage(data.language || 'en');
    } catch (error) {
        console.error('Error loading language:', error);
        applyLanguage('en');
    }
}

// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù„ØºØ©
function applyLanguage(lang) {
    document.body.dir = lang === 'ar' ? 'rtl' : 'ltr';
    document.body.style.textAlign = lang === 'ar' ? 'right' : 'left';
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    loadLanguage().then(() => {
        loadCategoryProducts();
    });
});
</script>
{% endblock %}